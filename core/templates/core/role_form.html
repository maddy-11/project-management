{% extends 'clients/home.html' %}
{% load widget_tweaks %}

{% block title %}Role Form - FineBooks{% endblock %}

{% block content %}
<div class="container my-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">
      <i class="fa fa-user-shield me-2"></i> {{ title }}
    </h2>
    <a href="{% url 'role-list' %}" class="btn btn-primary">
      <i class="fa fa-arrow-left me-1"></i> Back to Roles
    </a>
  </div>
  <div class="card">
    <div class="card-body">
      <form method="post">
        {% csrf_token %}
        <div class="mb-3">
          <label for="id_name" class="form-label">
            Role Name
            {% if form.fields.name.required %}
              <span class="text-danger">*</span>
            {% endif %}
          </label>
          {{ form.name|add_class:"form-control" }}
          {% if form.name.errors %}
            <div class="invalid-feedback d-block">
              {{ form.name.errors }}
            </div>
          {% endif %}
        </div>
        <div class="mb-3">
          <label for="id_description" class="form-label">
            Description
          </label>
          {{ form.description|add_class:"form-control" }}
          {% if form.description.errors %}
            <div class="invalid-feedback d-block">
              {{ form.description.errors }}
            </div>
          {% endif %}
        </div>
        <div class="mb-3">
          <label class="form-label">Page Access</label>
          <div class="card p-3 mb-2" style="background:#f8fafc;">
            {% for group, options in form.fields.page_access.choices %}
              {% if options %}
                <div class="mb-2">
                  <strong>{{ group }}</strong>
                  <div class="ms-3">
                    {% for value, label in options %}
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox"
                               name="{{ form.page_access.html_name }}"
                               value="{{ value }}"
                               id="id_page_access_{{ forloop.parentloop.counter }}_{{ forloop.counter }}"
                               {% if value in form.page_access.value %}checked{% endif %}>
                        <label class="form-check-label" for="id_page_access_{{ forloop.parentloop.counter }}_{{ forloop.counter }}">
                          {{ label }}
                        </label>
                      </div>
                    {% endfor %}
                  </div>
                </div>
              {% endif %}
            {% endfor %}
          </div>
          {% if form.page_access.errors %}
            <div class="invalid-feedback d-block">
              {{ form.page_access.errors }}
            </div>
          {% endif %}
        </div>
        <div class="mb-3">
          <div class="form-check form-switch">
            {{ form.partner_based }}
            <label class="form-check-label ms-2" for="id_partner_based">
              <strong>{{ form.partner_based.label }}</strong>
            </label>
          </div>
          {% if form.partner_based.help_text %}
            <div class="form-text">{{ form.partner_based.help_text }}</div>
          {% endif %}
          {% if form.partner_based.errors %}
            <div class="invalid-feedback d-block">
              {{ form.partner_based.errors }}
            </div>
          {% endif %}
        </div>
        <div class="mb-3">
          <label for="id_partners" class="form-label">
            Partners
          </label>
          {{ form.partners }}
          
          {% if form.partners.errors %}
            <div class="invalid-feedback d-block">
              {{ form.partners.errors }}
            </div>
          {% endif %}
          {% if form.partners.help_text %}
            <div class="form-text">{{ form.partners.help_text }}</div>
          {% endif %}
        </div>
        <div class="mb-3">
          <div class="form-check form-switch">
            {{ form.pipeline_based }}
            <label class="form-check-label ms-2" for="id_pipeline_based">
              <strong>{{ form.pipeline_based.label }}</strong>
            </label>
          </div>
          {% if form.pipeline_based.help_text %}
            <div class="form-text">{{ form.pipeline_based.help_text }}</div>
          {% endif %}
          {% if form.pipeline_based.errors %}
            <div class="invalid-feedback d-block">
              {{ form.pipeline_based.errors }}
            </div>
          {% endif %}
        </div>
        <div class="mb-3">
          <label for="id_pipelines" class="form-label">
            Pipelines
          </label>
          {{ form.pipelines }}
          {% if form.pipelines.errors %}
            <div class="invalid-feedback d-block">
              {{ form.pipelines.errors }}
            </div>
          {% endif %}
          {% if form.pipelines.help_text %}
            <div class="form-text">{{ form.pipelines.help_text }}</div>
          {% endif %}
        </div>
        <div class="d-flex justify-content-end gap-2">
          <button type="submit" class="btn btn-primary">
            <i class="fa fa-floppy-disk me-1"></i> Save
          </button>
          <a href="{% url 'role-list' %}" class="btn btn-primary">
            <i class="fa fa-xmark me-1"></i> Cancel
          </a>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}

{% block js %}
<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<style>
  /* Select2 Styling */
  .select2-container--bootstrap-5 .select2-selection--multiple {
    min-height: 38px;
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
  }
  
  /* Custom Toggle Switch Styling */
  .form-check-input:checked {
    background-color: var(--success);
    border-color: var(--success);
  }
  
  .form-check-input:focus {
    border-color: var(--primary);
    box-shadow: 0 0 0 0.25rem rgba(37, 99, 235, 0.25);
  }
  
  .form-switch .form-check-input {
    width: 3rem;
    height: 1.5rem;
    margin-top: 0.125rem;
  }
  
  .form-switch .form-check-input:before {
    content: "";
    position: absolute;
    width: 1.25rem;
    height: 1.25rem;
    border-radius: 50%;
    background-color: white;
    top: 0.125rem;
    left: 0.125rem;
    transition: transform 0.2s ease-in-out;
  }
  
  .form-switch .form-check-input:checked:before {
    transform: translateX(1.5rem);
  }
  
  .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice {
    background-color: var(--warning);
    color: white;
    border: none;
    border-radius: 0.25rem;
    padding: 0.25rem 0.5rem;
    margin: 0.25rem;
  }
  
  .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice__remove {
    color: white;
    margin-left: 0.5rem;
    border-left: 1px solid rgba(255, 255, 255, 0.3);
    padding-left: 0.5rem;
  }
  
  .select2-container--bootstrap-5 .select2-selection--multiple .select2-selection__choice__remove:hover {
    background-color: rgba(255, 255, 255, 0.2);
    color: white;
  }
</style>

<!-- Select2 JavaScript -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
  $(document).ready(function() {
    // Initialize Select2 for partners field
    $('#id_partners').select2({
      theme: 'bootstrap-5',
      placeholder: 'Select partners...',
      allowClear: true,
      width: '100%'
    });
    // Initialize Select2 for pipelines field
    $('#id_pipelines').select2({
      theme: 'bootstrap-5',
      placeholder: 'Select pipelines...',
      allowClear: true,
      width: '100%'
    });
    
    // Handle partner-based toggle functionality
    function togglePartnersField() {
      const isPartnerBased = $('#id_partner_based').is(':checked');
      const partnersField = $('#id_partners').closest('.mb-3');
      
      if (isPartnerBased) {
        partnersField.show();
        $('#id_partners').prop('disabled', false);
      } else {
        partnersField.hide();
        $('#id_partners').prop('disabled', true);
        $('#id_partners').val(null).trigger('change');
      }
    }
    // Handle pipeline-based toggle functionality
    function togglePipelinesField() {
      const isPipelineBased = $('#id_pipeline_based').is(':checked');
      const pipelinesField = $('#id_pipelines').closest('.mb-3');
      
      if (isPipelineBased) {
        pipelinesField.show();
        $('#id_pipelines').prop('disabled', false);
      } else {
        pipelinesField.hide();
        $('#id_pipelines').prop('disabled', true);
        $('#id_pipelines').val(null).trigger('change');
      }
    }
    
    // Initialize toggle state
    togglePartnersField();
    togglePipelinesField();
    
    // Handle toggle change
    $('#id_partner_based').on('change', function() {
      togglePartnersField();
    });
    $('#id_pipeline_based').on('change', function() {
      togglePipelinesField();
    });
  });
</script>
{% endblock %}