{% extends 'clients/home.html' %}

{% block content %}
{% csrf_token %}
<style>
  .page-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px;
    padding: 2rem;
    margin-bottom: 2rem;
    box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
  }
  
  .filters-section {
    background: white;
    border-radius: 15px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
    border: 1px solid #e9ecef;
  }
  
  .filters-section h5 {
    color: #495057;
    margin-bottom: 1rem;
    font-weight: 600;
  }
  
  .filter-row {
    display: flex;
    flex-wrap: wrap;
    gap: 1rem;
    align-items: end;
  }
  
  .filter-group {
    flex: 1;
    min-width: 200px;
  }
  
  .filter-group label {
    font-weight: 500;
    color: #495057;
    margin-bottom: 0.5rem;
  }
  
  .invoices-table {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
  }
  
  .table-header {
    background: #f8f9fa;
    padding: 1rem 1.5rem;
    border-bottom: 1px solid #e9ecef;
  }
  
  .table-header h5 {
    margin: 0;
    color: #495057;
    font-weight: 600;
  }
  
  .table th {
    background: #f8f9fa;
    border: none;
    padding: 1rem;
    font-weight: 600;
    color: #495057;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .table td {
    padding: 1rem;
    vertical-align: middle;
    border-color: #e9ecef;
  }
  
  .status-badge {
    padding: 0.375rem 0.75rem;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .status-paid {
    background: #d4edda;
    color: #155724;
  }
  
  .status-due {
    background: #f8d7da;
    color: #721c24;
  }
  
  .status-scheduled {
    background: #d1ecf1;
    color: #0c5460;
  }
  
  .status-dropdown {
    min-width: 120px;
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    border-radius: 0.375rem;
    border: 1px solid #ced4da;
  }
  
  .status-dropdown:focus {
    border-color: #86b7fe;
    box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
  }
  
  .table-success {
    background-color: #d1e7dd !important;
    transition: background-color 0.3s ease;
  }
  
  .amount-cell {
    font-weight: 600;
    font-family: 'Courier New', monospace;
  }
  
  .action-buttons {
    display: flex;
    gap: 0.5rem;
  }
  
  .no-results {
    text-align: center;
    padding: 3rem;
    color: #6c757d;
  }
  
  .no-results i {
    font-size: 3rem;
    margin-bottom: 1rem;
    opacity: 0.5;
  }
  
  /* Select2 Styling */
  .select2-container--bootstrap-5 .select2-selection--single {
    height: 38px;
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
  }
  
  .select2-container--bootstrap-5 .select2-selection--single .select2-selection__rendered {
    line-height: 36px;
    padding-left: 12px;
    color: #495057;
  }
  
  .select2-container--bootstrap-5 .select2-selection--single .select2-selection__arrow {
    height: 36px;
  }
  
  .select2-container--bootstrap-5 .select2-dropdown {
    border: 1px solid #ced4da;
    border-radius: 0.375rem;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
    z-index: 9999;
  }
  
  .select2-container--bootstrap-5 .select2-results__option {
    padding: 8px 12px;
  }
  
  .select2-container--bootstrap-5 .select2-results__option--highlighted[aria-selected] {
    background-color: #2563eb;
    color: white;
  }
  
  @media (max-width: 768px) {
    .filter-row {
      flex-direction: column;
    }
    
    .filter-group {
      min-width: 100%;
    }
  }
</style>

<div class="container-fluid my-4">
  <!-- Page Header -->
  <!-- <div class="page-header">
    <div class="row align-items-center">
      <div class="col-md-8">
        <h1 class="mb-2">
          <i class="fa fa-history me-3"></i>Past Invoices
        </h1>
        <p class="mb-0 opacity-75">View and manage all past invoices with advanced filtering</p>
      </div>
      <div class="col-md-4 text-end">
        <a href="{% url 'invoices-list' %}" class="btn btn-outline-light">
          <i class="fa fa-list me-2"></i>View All Invoices
        </a>
      </div>
    </div>
  </div> -->

  <!-- Filters Section -->
  <div class="filters-section">
    <h5><i class="fa fa-filter me-2"></i>Filter Invoices</h5>
    
    <form method="GET" id="filterForm">
      <div class="filter-row">
        <div class="filter-group">
          <label for="project">Project</label>
          <select name="project" id="project" class="form-select" style="width: 100%;">
            <option value="">All Projects</option>
            {% for project_id, project_name in projects %}
              <option value="{{ project_name }}" {% if filters.project == project_name %}selected{% endif %}>
                {{ project_name }}
              </option>
            {% endfor %}
          </select>
        </div>
        
        <div class="filter-group">
          <label for="partner">Partner</label>
          <select name="partner" id="partner" class="form-select">
            <option value="">All Partners</option>
            {% for partner_id, partner_name in partners %}
              <option value="{{ partner_name }}" {% if filters.partner == partner_name %}selected{% endif %}>
                {{ partner_name }}
              </option>
            {% endfor %}
          </select>
        </div>
        
        <div class="filter-group">
          <label>&nbsp;</label>
          <button type="button" class="btn btn-outline-secondary" onclick="clearFilters()">
            <i class="fa fa-times me-2"></i>Clear
          </button>
        </div>
      </div>
    </form>
  </div>

  <!-- Invoices Table -->
  <div class="invoices-table">
    <div class="table-header">
      <h5><i class="fa fa-table me-2"></i>Past Invoices ({{ invoices.count }} results)</h5>
    </div>
    
    {% if invoices %}
      <div class="table-responsive">
       <table class="table table-hover mb-0">
  <thead class="text-nowrap">
    <tr>
      <th>No</th>
      <th>Project</th>
      <th>Status</th>
      <th>Amount</th>
      <th>Invoiced Amount</th>
      <th>Due Date</th>
      <th>Description</th>
      <th>Invoice #</th>
      <th>Partner</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody class="text-nowrap">
  {% for invoice in invoices %}
  <tr>
    <td>{{ forloop.counter }}</td>

    <!-- Project -->
    <td>
      {{ invoice.project.name }}
    </td>

    <!-- Status -->
    <td>
      {% if request.user.role.name == 'Management' %}
      <select class="form-select form-select-sm status-dropdown disabled"
              data-invoice-id="{{ invoice.pk }}"
              data-current-status="{{ invoice.status }}">
        <option value="due" {% if invoice.status == 'due' %}selected{% endif %}>Due</option>
        <option value="paid" {% if invoice.status == 'paid' %}selected{% endif %}>Paid</option>
        <option value="scheduled" {% if invoice.status == 'scheduled' %}selected{% endif %}>Scheduled</option>
        <option value="custom" {% if invoice.status == 'custom' %}selected{% endif %}>Custom</option>
      </select>
      {% else %}
      <span class="badge bg-secondary">{{ invoice.status|title }}</span>
      {% endif %}
    </td>

    <!-- Amount -->
    <td class="amount-cell">{{ invoice.amount }} ({{ invoice.project.currency }})</td>

    <!-- Invoiced Amount (net_amount fallback to amount) -->
    <td class="amount-cell">{{ invoice.net_amount|default:invoice.amount }} ({{ invoice.project.currency }})</td>

    <!-- Due Date -->
    <td>
      {% if invoice.due_date %}
      <span class="{% if invoice.due_date < today %}text-danger{% elif invoice.due_date <= next_month %}text-warning{% endif %}">
        {{ invoice.due_date }}
      </span>
      {% else %}
      <span class="text-muted">No due date</span>
      {% endif %}
    </td>

    <!-- Description / Payment Type -->
    <td>
      {% if invoice.payment_type == 'custom' %}
        {{ invoice.custom_type|default:'Custom' }}
      {% elif invoice.payment_type == 'cost_breakdown' %}
        {{ invoice.description|default:'Cost Breakdown' }}
      {% elif invoice.payment_type == 'amc' and invoice.amc_year %}
        AMC (Year {{ invoice.amc_year }})
      {% else %}
        {{ invoice.payment_type|title }}
      {% endif %}
    </td>

    <!-- Invoice # -->
    <td><strong>{{ invoice.invoice_no }}</strong></td>

    <!-- Partner -->
    <td>
      {% if invoice.project.partner %}
        {{ invoice.project.partner.name }}
      {% else %}
        <span class="text-muted">No Partner</span>
      {% endif %}
    </td>

    <!-- Actions -->
    <td>
      <div class="action-buttons">
        {% if request.user.role.name == 'Management' %}
        <a href="{% url 'project-invoices' invoice.project.pk %}" class="btn btn-sm btn-outline-primary" title="Edit Invoice">
          <i class="fa fa-edit"></i>
        </a>
        {% endif %}
        <button type="button" class="btn btn-sm btn-outline-success export-btn"
                data-invoice-id="{{ invoice.pk }}"
                data-project-id="{{ invoice.project.pk }}"
                data-project-name="{{ invoice.project.name }}"
                data-invoice-no="{{ invoice.invoice_no }}"
                title="Export Invoice">
          <i class="fa fa-download"></i>
        </button>
      </div>
    </td>
  </tr>
  {% endfor %}
</tbody>
</table>
      </div>
    {% else %}
      <div class="no-results">
        <i class="fa fa-search"></i>
        <h5>No invoices found</h5>
        <p>Try adjusting your filters or create new invoices.</p>
        <a href="{% url 'invoices-list' %}" class="btn btn-primary btn-sm d-inline-flex align-items-center">
            View All Invoices
          </a>
      </div>
    {% endif %}
  </div>
</div>

{% endblock %}

{% block js %}
<!-- Select2 CSS/JS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
$(document).ready(function() {
  // Setup CSRF token for all AJAX requests
  $.ajaxSetup({
    beforeSend: function(xhr, settings) {
      if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
        xhr.setRequestHeader("X-CSRFToken", $('[name=csrfmiddlewaretoken]').val());
      }
    }
  });

  // Initialize Select2
  $('#project, #partner').select2({
    placeholder: 'Select...',
    allowClear: true,
    width: '100%'
  });

  // Handle filter changes
  $('#project, #partner').on('change', function() {
    applyFilters();
  });
});

function applyFilters() {
  const project = $('#project').val();
  const partner = $('#partner').val();
  
  // Build filter URL
  let filterUrl = '{% url "invoices-past" %}?';
  if (project) filterUrl += `project=${encodeURIComponent(project)}&`;
  if (partner) filterUrl += `partner=${encodeURIComponent(partner)}&`;
  
  // Remove trailing & and reload page with filters
  filterUrl = filterUrl.replace(/&$/, '');
  window.location.href = filterUrl;
}

function clearFilters() {
  window.location.href = '{% url "invoices-past" %}';
}

// Handle status dropdown changes
$(document).on('change', '.status-dropdown', function() {
  const $select = $(this);
  const invoiceId = $select.data('invoice-id');
  const newStatus = $select.val();
  const currentStatus = $select.data('current-status');
  
  // Don't make AJAX call if status hasn't actually changed
  if (newStatus === currentStatus) {
    return;
  }
  
  // Show loading state
  const originalValue = $select.val();
  $select.prop('disabled', true);
  
  // Make AJAX request to update status
  $.ajax({
    url: `/invoices/${invoiceId}/update-status/`,
    method: 'POST',
    headers: {
      'X-Requested-With': 'XMLHttpRequest',
      'Content-Type': 'application/json'
    },
    data: JSON.stringify({
      status: newStatus
    }),
    success: function(response) {
      if (response.success) {
        // Update the data attribute with new status
        $select.data('current-status', response.status);
        
        // Show success message
        const $row = $select.closest('tr');
        $row.addClass('table-success');
        setTimeout(() => {
          $row.removeClass('table-success');
        }, 2000);
        
        // Update the status display if needed
        $select.val(response.status);
      } else {
        // Revert to original value on error
        $select.val(currentStatus);
        alert('Error updating status: ' + (response.error || 'Unknown error'));
      }
    },
    error: function(xhr, status, error) {
      // Revert to original value on error
      $select.val(currentStatus);
      let errorMessage = 'Error updating status: ';
      if (xhr.responseJSON && xhr.responseJSON.error) {
        errorMessage += xhr.responseJSON.error;
      } else {
        errorMessage += error;
      }
      alert(errorMessage);
    },
    complete: function() {
      // Re-enable the select
      $select.prop('disabled', false);
    }
  });
});

// Handle export button clicks
$(document).on('click', '.export-btn', function() {
  const invoiceId = $(this).data('invoice-id');
  const projectId = $(this).data('project-id');
  const projectName = $(this).data('project-name');
  const invoiceNo = $(this).data('invoice-no');
  exportSingleInvoice(invoiceId, projectId, projectName, invoiceNo);
});

function exportSingleInvoice(invoiceId, projectId, projectName, invoiceNo) {
  // Show loading state
  const $btn = $(`.export-btn[data-invoice-id="${invoiceId}"]`);
  const originalHtml = $btn.html();
  $btn.html('<i class="fa fa-spinner fa-spin"></i>').prop('disabled', true);
  
  // Make AJAX request to download single invoice
  $.ajax({
    url: `/projects/${projectId}/download-invoices/`,
    method: 'POST',
    data: {
      export_type: 'selected',
      format: 'word',
      selected_invoices: [invoiceId],
      csrfmiddlewaretoken: $('[name=csrfmiddlewaretoken]').val()
    },
    traditional: true,
    xhrFields: {
      responseType: 'blob'
    },
    success: function(data, status, xhr) {
      // Create download link
      const blob = new Blob([data], { type: 'application/vnd.openxmlformats-officedocument.wordprocessingml.document' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `invoice_${projectName}_${invoiceNo.replace(/[^a-zA-Z0-9-]/g, '_')}_${new Date().toISOString().slice(0, 10)}.docx`;
      document.body.appendChild(a);
      a.click();
      window.URL.revokeObjectURL(url);
      document.body.removeChild(a);
      
      // Reset button
      $btn.html(originalHtml).prop('disabled', false);
    },
    error: function(xhr, status, error) {
      let errorMessage = 'Error generating invoice: ';
      if (xhr.responseJSON && xhr.responseJSON.error) {
        errorMessage += xhr.responseJSON.error;
      } else {
        errorMessage += error;
      }
      alert(errorMessage);
      $btn.html(originalHtml).prop('disabled', false);
    }
  });
}
</script>
{% endblock %}
